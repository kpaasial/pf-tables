#!/bin/sh 

# Script for downloading a set of IP/CIDR tables and loading them
# to pf(4).

# CAVEATS: This will probably work on FreeBSD and OpenBSD without
# modifications. No guarantees of working on other BSD OSes.
PREFIX=@@PREFIX@@


: ${PFTABLES_CONFIG:="/${PREFIX}/etc/pf-tables.conf"}
: ${PFTABLES_DBDIR:="/var/db/pf-tables"}


CAT=/bin/cat
CP=/bin/cp
FTP=/usr/bin/ftp
MKTEMP=/usr/bin/mktemp
PFCTL=/sbin/pfctl
RM=/bin/rm
SED=/usr/bin/sed
UNAME=/usr/bin/uname

COMMAND=fetch

DOWNLOAD=yes
STORE=yes
LOAD=


usage() {
    echo "Usage: $0 [-d database_directory] [-f config_file ] [fetch|load|all]"
    exit 1
}

# TODO: Test on NetBSD and DragonFlyBSD
OSTYPE=$($UNAME)

case $OSTYPE in 
    FreeBSD)
        ;;
    OpenBSD)
        ;;
    *)
        echo "Unsupported operating system"
        exit 1
        ;;
esac  

while getopts "d:f:h" o
do
    case "$o" in 
    d)  PFTABLES_DBDIR=$OPTARG;;  
    f)  PFTABLES_CONFIG=$OPTARG;;
    h)  usage;;
    *)  usage;;
    esac
done

shift $((OPTIND-1))

if [ $# -gt 0 ]; then 
    COMMAND=$1
fi


case "${COMMAND}" in
    "fetch" ) DOWNLOAD=yes; STORE=yes; LOAD=;;
    "load" ) DOWNLOAD=; STORE=; LOAD=yes;;
    "all" ) DOWNLOAD=yes; STORE=yes; LOAD=yes;;
esac


if test ! -r "${PFTABLES_CONFIG}"; then
    echo "ERROR: Configuration file ${PFTABLES_CONFIG} is not readable."
    exit 1
fi

if test ! -d "${PFTABLES_DBDIR}"; then
    echo "ERROR: Database directory ${PFTABLES_DBDIR} does not exist."
    exit 1
fi


finish() {
    # Make sure we are deleting a temporary directory created by this script
    # and not something else. This script will be run as root, better safe than
    # sorry.
    if test -n "${SCRATCH}" \
        && test -z "${SCRATCH##/tmp/pftables-??????????}" ; then
         ${RM} -r "${SCRATCH}"
    else
        echo "WARNING: Unexpected value for SCRATCH: ${SCRATCH}"
    fi     
}

# Download a tablefile from URL and place its contents in TMPFILE.
# Remove # and ; comments.
download_tablefile() {
    URL=$1
    TMPFILE=$2

    ${FTP} -v -o - "${URL}" > "${TMPFILE}.orig" || return 1
    ${SED} -e 's/[;#].*$//g' -e '/^\s*$/d' "${TMPFILE}.orig" > "${TMPFILE}" \
        || return 1

}

# Load contents of TABLEFILEPATH into PF table TABLE.
load_tablefile() {
    TABLEFILEPATH=$1
    TABLE=$2
    
    if test ! -r "${TABLEFILEPATH}"; then
        echo "ERROR: Table file ${TABLEFILEPATH} is not readable."
        return 1
    fi
    
    if ! ${PFCTL} -T show -t "${TABLE}" >/dev/null 2>&1 ; then
        echo "ERROR: PF table ${TABLE} not found in the active ruleset".
        return 1
    fi
 
    ${PFCTL} -T flush -t "${TABLE}" || return 1
    ${PFCTL} -T add -t "${TABLE}" -f "${TABLEFILEPATH}" || return 1
}


if test "${DOWNLOAD}" = "yes"; then
    # Create the temporary directory
    TEMPLATE="XXXXXXXXXX"
    SCRATCH=$(${MKTEMP} -d /tmp/pftables-${TEMPLATE})
    trap finish EXIT

    # Counter to keep track of downloaded tables.
    downloaded_tables=0

    while read line
    do  
        line="${line%%#*}"

        if test -z "${line}"; then
            continue
        fi

        set -- $line

        URL=$1
        TABLE=$2


        if test -z "${URL}" || test -z "${TABLE}"; then
            echo "ERROR: Malformed line ${line} in config file ${PFTABLES_CONFIG}"
            exit 1
        fi

        TMPFILE="${SCRATCH}/${TABLE}.txt"

        if ! download_tablefile "${URL}" "${TMPFILE}" ; then
            echo "ERROR: Something went wrong downloading ${URL}."
            exit 1
        fi 

        downloaded_tables=$(($downloaded_tables + 1 ))
            
    done <"${PFTABLES_CONFIG}"

    # The store pass can not be done unless the download pass has
    # finished successfully.
    
    if test "${STORE}" = "yes" && test $downloaded_tables -gt 0; then
        # Copy processed tablefiles (*.txt) from ${SCRATCH} to 
        # ${PFTABLES_DBDIR}
        ${CP} ${SCRATCH}/*.txt "${PFTABLES_DBDIR}"
    fi
fi

if test "${LOAD}" = "yes"; then
    # Read the config file the second time. Not the most elegant
    # programming but we need to know which tables are to be loaded.
    while read line
    do  
        line="${line%%#*}"

        if test -z "${line}"; then
            continue
        fi

        set -- $line

        URL=$1
        TABLE=$2

        if test -z "${URL}" || test -z "${TABLE}"; then
            echo "Malformed line ${line} in config file ${PFTABLES_CONFIG}"
            exit 1
        fi

        TABLEFILEPATH="${PFTABLES_DBDIR}/${TABLE}.txt"

        if ! load_tablefile "${TABLEFILEPATH}" "${TABLE}" ; then
            echo "ERROR: Something went wrong loading ${TABLE} to PF."
            exit 1
        fi 

    done <"${PFTABLES_CONFIG}"
fi

exit 0
